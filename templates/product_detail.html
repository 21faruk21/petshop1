<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ product.name }} ‚Äì √úr√ºn Detayƒ± | MaviPetShop</title>

  <!-- Google Font: Outfit -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  
  <!-- Modern CSS & App JS (preload for performance) -->
  <link rel="preload" href="{{ url_for('static', filename='modern.css') }}" as="style">
  <link rel="preload" href="{{ url_for('static', filename='app.js') }}" as="script">
  <link href="{{ url_for('static', filename='modern.css') }}" rel="stylesheet"/>

  <style>
    /* Temel renkler ve font */
    body {
      background: #181a20;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      font-family: 'Outfit', 'Segoe UI', Arial, sans-serif;
    }
    .detail-card {
      background: #23262f;
      color: #f5f5f5;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(5,63,243,0.18);
      margin: 3rem auto 2rem auto;
      max-width: 900px;
      padding: 2.5rem 2rem 2rem 2rem;
      display: flex;
      flex-direction: row;
      gap: 2.5rem;
      align-items: center;
    }
    .detail-card img {
      max-width: 340px;
      width: 100%;
      border-radius: 1.2rem;
      background: #fff;
      box-shadow: 0 4px 16px rgba(5,63,243,0.10);
    }
    .detail-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .detail-info h3 {
      font-size: 2rem;
      font-weight: 900;
      color: #6ea8fe;
      margin-bottom: 0.7em;
    }
    .detail-info .text-muted {
      color: #bfc9d8 !important;
      font-size: 1.1rem;
      margin-bottom: 1em;
    }
    .detail-info .text-success {
      color: #00e6a7 !important;
      font-weight: 900;
      font-size: 1.8rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, #053ff3, #0d5bff);
      border: none;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 0.8rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(5,63,243,0.25);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #0d5bff, #053ff3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(5,63,243,0.35);
    }
    .btn-secondary {
      background: #495057;
      border: none;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      border-radius: 0.8rem;
    }
    .wishlist-btn {
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .wishlist-btn:hover {
      transform: scale(1.1);
    }
    .star-rating i {
      cursor: pointer;
      font-size: 1.2rem;
      margin-right: 0.2rem;
      transition: color 0.2s ease;
    }
    .star-rating i:hover {
      color: #ffc107 !important;
    }
    .review-item {
      background: rgba(35, 38, 47, 0.6);
      border-color: rgba(108, 168, 254, 0.2) !important;
    }
    @media (max-width: 768px) {
      .detail-card { flex-direction: column; padding: 1.5rem 1rem; }
      .detail-card img { max-width: 100%; }
    }
  </style>
</head>

<body class="{% if theme=='dark' %}dark-mode{% endif %}">

  <!-- Kampanya Barƒ± -->
  <div class="campaign-bar" style="max-width:900px;margin:2rem auto 0 auto;border-radius:1.2rem;box-shadow:0 4px 16px rgba(5,63,243,0.10);padding:.7em 1.2em;text-align:center;">
    üéâ 300 TL ve √ºzeri sipari≈ülerde √úCRETSƒ∞Z KARGO! üöö
  </div>
  
  <!-- Tema Toggle -->
  <button id="themeToggle" class="btn btn-light d-flex align-items-center position-absolute" style="top:2.2rem;right:2.2rem;border-radius:50%;width:44px;height:44px;justify-content:center;box-shadow:0 2px 8px rgba(5,63,243,0.08);font-size:1.4rem;z-index:10;" title="Tema Deƒüi≈ütir">
    <i id="themeIcon" class="fa fa-moon"></i>
  </button>
  
  <div class="container">
    <div class="card detail-card">
      <img src="{{ product.image_url }}" alt="{{ product.name }}"/>
      <div class="detail-info">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h3>{{ product.name }}
            {% if product.brand %}<span class="badge bg-secondary ms-2">{{ product.brand }}</span>{% endif %}
          </h3>
          <!-- Wishlist Kalp Butonu -->
          {% if session.user_logged_in %}
          <button class="btn btn-outline-danger wishlist-btn" onclick="PetShopApp.wishlist.toggle({{ product.id }})" title="Favorilere Ekle/√áƒ±kar">
            <i id="wishlist-icon-{{ product.id }}" class="fas fa-heart"></i>
          </button>
          {% endif %}
        </div>
        
        <p class="text-muted">{{ product.category }} /
          {% if product.subcategory %}
            {% if product.subcategory is string and product.subcategory.startswith('[') %}
              {{ product.subcategory|fromjson|join(', ') }}
            {% elif product.subcategory is list %}
              {{ product.subcategory|join(', ') }}
            {% else %}
              {{ product.subcategory }}
            {% endif %}
          {% endif %}
        </p>
        
        {% if product.description %}
          <p class="mb-3">{{ product.description }}</p>
        {% endif %}
        
        <h4 class="text-success mb-4">{{ product.price }} TL</h4>
        
        <div class="mt-auto d-flex gap-3">
          <a href="/add_to_cart/{{ product.id }}" class="btn btn-primary"><i class="fa fa-cart-plus me-2"></i>Sepete Ekle</a>
          <a href="/" class="btn btn-secondary"><i class="fa fa-arrow-left me-2"></i>Anasayfaya D√∂n</a>
        </div>
      </div>
    </div>
  </div>

  <!-- √úr√ºn Yorumlarƒ± ve Puanlama -->
  {% if reviews or session.user_logged_in %}
  <div class="container">
    <div class="card detail-card mt-4">
      <div class="w-100">
        <h4 class="mb-4">
          <i class="fas fa-star text-warning me-2"></i>√úr√ºn Yorumlarƒ±
          {% if avg_rating > 0 %}
            <span class="badge bg-warning text-dark ms-2">{{ avg_rating }}/5 ‚≠ê</span>
            <small class="text-muted">({{ total_reviews }} yorum)</small>
          {% endif %}
        </h4>
        
        <!-- Yorum Yazma Formu (Sadece giri≈ü yapmƒ±≈ü kullanƒ±cƒ±lar) -->
        {% if session.user_logged_in and not user_reviewed %}
        <div class="review-form mb-4 p-3 bg-dark rounded">
          <h6 class="text-primary">Bu √ºr√ºn hakkƒ±nda yorum yapƒ±n:</h6>
          <div class="rating-input mb-3">
            <label class="form-label">Puanƒ±nƒ±z:</label>
            <div class="star-rating">
              <i class="fas fa-star" data-rating="1"></i>
              <i class="fas fa-star" data-rating="2"></i>
              <i class="fas fa-star" data-rating="3"></i>
              <i class="fas fa-star" data-rating="4"></i>
              <i class="fas fa-star" data-rating="5"></i>
            </div>
          </div>
          <textarea class="form-control mb-3" id="reviewComment" placeholder="Yorumunuzu yazƒ±n..." rows="3"></textarea>
          <button class="btn btn-primary" onclick="submitReview({{ product.id }})">Yorum G√∂nder</button>
        </div>
        {% elif session.user_logged_in and user_reviewed %}
          <div class="alert alert-info">Bu √ºr√ºn i√ßin daha √∂nce yorum yapmƒ±≈üsƒ±nƒ±z.</div>
        {% else %}
          <div class="alert alert-warning">Yorum yapabilmek i√ßin <a href="/login" class="text-warning">giri≈ü yapƒ±n</a>.</div>
        {% endif %}
        
        <!-- Mevcut Yorumlar -->
        {% if reviews %}
        <div class="reviews-list">
          {% for review in reviews %}
          <div class="review-item p-3 mb-3 border rounded">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong class="text-primary">{{ review.author_name }}</strong>
                <div class="stars text-warning">
                  {% for i in range(1, 6) %}
                    {% if i <= review.rating %}
                      <i class="fas fa-star"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              <small class="text-muted">{{ review.created_at.strftime('%d.%m.%Y') if review.created_at else '' }}</small>
            </div>
            <p class="mb-0 mt-2">{{ review.comment }}</p>
          </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-muted text-center py-4">Hen√ºz yorum bulunmuyor. ƒ∞lk yorumu siz yapƒ±n!</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Footer -->
  <footer style="max-width:900px;margin:2.5rem auto 0 auto;text-align:center;color:#bfc9d8;background:none;">
    ¬© 2025 Mavi Petshop. T√ºm haklarƒ± saklƒ±dƒ±r.
  </footer>
  
  <!-- App Scripts -->
  <script src="{{ url_for('static', filename='app.js') }}"></script>
  <script>
    // Initialize theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize theme first (most important for UX)
      if (PetShopApp && PetShopApp.theme) {
        PetShopApp.theme.init();
      }
      
      console.log('üé® Product Detail tema sistemi ba≈ülatƒ±ldƒ±!');
      
      // Initialize wishlist status
      {% if session.user_logged_in %}
      checkWishlistStatus({{ product.id }});
      {% endif %}
    });
    
    // Wishlist functions
    function checkWishlistStatus(productId) {
      if (!PetShopApp.wishlist) return;
      PetShopApp.wishlist.checkStatus(productId).then(inWishlist => {
        const icon = document.getElementById(`wishlist-icon-${productId}`);
        if (icon) {
          icon.className = inWishlist ? 'fas fa-heart text-danger' : 'fas fa-heart';
        }
      });
    }
    
    // Star rating functionality
    document.querySelectorAll('.star-rating i').forEach(star => {
      star.addEventListener('click', function() {
        const rating = this.getAttribute('data-rating');
        const stars = this.parentElement.querySelectorAll('i');
        
        stars.forEach((s, index) => {
          if (index < rating) {
            s.className = 'fas fa-star text-warning';
          } else {
            s.className = 'fas fa-star';
          }
        });
        
        this.parentElement.setAttribute('data-selected-rating', rating);
      });
    });
    
    // Submit review function
    function submitReview(productId) {
      const ratingElement = document.querySelector('.star-rating');
      const rating = ratingElement ? ratingElement.getAttribute('data-selected-rating') : null;
      const comment = document.getElementById('reviewComment').value.trim();
      
      if (!rating) {
        alert('L√ºtfen bir puan verin!');
        return;
      }
      
      if (!comment) {
        alert('L√ºtfen yorumunuzu yazƒ±n!');
        return;
      }
      
      fetch('/api/reviews/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          product_id: productId,
          rating: parseInt(rating),
          comment: comment
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Yorumunuz ba≈üarƒ±yla g√∂nderildi!');
          location.reload();
        } else {
          alert('Hata: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Review submit error:', error);
        alert('Bir hata olu≈ütu!');
      });
    }
  </script>
</body>
</html>